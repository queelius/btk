<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTK Bookmark Graph Viewer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #ffffff;
            color: #333;
        }

        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #controls button {
            margin: 5px;
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        #controls button:hover {
            background: #45a049;
        }

        #info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 300px;
            z-index: 1000;
        }

        .node {
            cursor: pointer;
            stroke: #333;
            stroke-width: 1.5px;
        }

        .node.starred {
            stroke: #ffd700;
            stroke-width: 2.5px;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.4;
        }

        .node text {
            font-size: 10px;
            pointer-events: none;
            fill: #333;
        }

        #tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.98);
            color: #333;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            pointer-events: none;
            display: none;
            z-index: 2000;
            max-width: 300px;
        }

        #file-input {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="controls">
        <h3>BTK Graph Viewer</h3>
        <input type="file" id="file-input" accept=".json">
        <br>
        <label>
            <input type="checkbox" id="show-labels" checked> Show Labels
        </label>
        <br>
        <label>
            Min Weight: <input type="range" id="min-weight" min="0" max="10" step="0.1" value="0">
            <span id="weight-value">0</span>
        </label>
        <br>
        <button id="reset-zoom">Reset Zoom</button>
    </div>

    <div id="info">
        <h4>Graph Info</h4>
        <div id="graph-stats">Load a graph file to begin</div>
    </div>

    <div id="tooltip"></div>

    <svg id="graph"></svg>

    <script>
        const width = window.innerWidth;
        const height = window.innerHeight;

        const svg = d3.select("#graph")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g");

        let simulation;
        let graphData;
        let minWeight = 0;

        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 10])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        // Reset zoom button
        d3.select("#reset-zoom").on("click", () => {
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
            );
        });

        // File input
        d3.select("#file-input").on("change", function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        graphData = JSON.parse(e.target.result);
                        updateGraph();
                    } catch (err) {
                        alert("Error parsing JSON: " + err.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        // Min weight slider
        d3.select("#min-weight").on("input", function() {
            minWeight = +this.value;
            d3.select("#weight-value").text(minWeight.toFixed(1));
            if (graphData) updateGraph();
        });

        // Show labels checkbox
        d3.select("#show-labels").on("change", function() {
            d3.selectAll(".node text").style("display", this.checked ? "block" : "none");
        });

        function updateGraph() {
            // Filter links by weight
            const filteredLinks = graphData.links.filter(l => l.weight >= minWeight);

            // Get nodes that have at least one link
            const nodeIds = new Set();
            filteredLinks.forEach(l => {
                nodeIds.add(l.source.id || l.source);
                nodeIds.add(l.target.id || l.target);
            });
            const filteredNodes = graphData.nodes.filter(n => nodeIds.has(n.id));

            // Update stats
            d3.select("#graph-stats").html(`
                <strong>Nodes:</strong> ${filteredNodes.length} / ${graphData.nodes.length}<br>
                <strong>Links:</strong> ${filteredLinks.length} / ${graphData.links.length}<br>
                <strong>Min Weight:</strong> ${minWeight.toFixed(1)}
            `);

            // Clear existing graph
            g.selectAll("*").remove();

            // Create simulation
            simulation = d3.forceSimulation(filteredNodes)
                .force("link", d3.forceLink(filteredLinks)
                    .id(d => d.id)
                    .distance(d => 100 / Math.sqrt(d.weight)))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(20));

            // Create links
            const link = g.append("g")
                .selectAll("line")
                .data(filteredLinks)
                .enter().append("line")
                .attr("class", "link")
                .style("stroke-width", d => Math.sqrt(d.weight));

            // Create nodes
            const node = g.append("g")
                .selectAll("g")
                .data(filteredNodes)
                .enter().append("g")
                .attr("class", "node-group")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            node.append("circle")
                .attr("class", d => d.starred ? "node starred" : "node")
                .attr("r", 8)
                .style("fill", d => d.starred ? "#ffd700" : colorByTags(d.tags));

            node.append("text")
                .attr("dx", 12)
                .attr("dy", 4)
                .text(d => d.title.substring(0, 30) + (d.title.length > 30 ? "..." : ""));

            // Tooltip
            const tooltip = d3.select("#tooltip");

            node.on("mouseover", function(event, d) {
                const tags = d.tags.slice(0, 5).join(", ");
                tooltip.html(`
                    <strong>${d.title}</strong><br>
                    <a href="${d.url}" target="_blank">${d.url}</a><br>
                    <strong>Tags:</strong> ${tags}${d.tags.length > 5 ? '...' : ''}<br>
                    <strong>ID:</strong> ${d.id}
                `)
                .style("display", "block")
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY + 10) + "px");
            })
            .on("mouseout", function() {
                tooltip.style("display", "none");
            })
            .on("click", function(event, d) {
                window.open(d.url, "_blank");
            });

            // Update positions on tick
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });
        }

        function colorByTags(tags) {
            // Simple color based on first tag
            if (tags.length === 0) return "#999";
            const firstTag = tags[0];

            // Hash string to color
            let hash = 0;
            for (let i = 0; i < firstTag.length; i++) {
                hash = firstTag.charCodeAt(i) + ((hash << 5) - hash);
            }
            const hue = hash % 360;
            return `hsl(${hue}, 70%, 50%)`;
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    </script>
</body>
</html>
